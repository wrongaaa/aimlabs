name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: src-repo

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Compile and Package
        shell: cmd
        run: |
          mkdir C:\app
          xcopy /E /I src-repo C:\app\repo
          cd /d C:\app\repo
          mkdir build
          mkdir out
          dir /s /b src\*.java > sources.txt
          javac -encoding UTF-8 -d build @sources.txt
          jar cfm out\AimLabs.jar MANIFEST.MF -C build .
          jpackage --input out --main-jar AimLabs.jar --name AimLabs --type app-image --dest C:\app\dist --java-options "-Xmx512m"

      - name: Zip release
        shell: pwsh
        run: Compress-Archive -Path C:\app\dist\AimLabs\* -DestinationPath AimLabs-windows.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AimLabs-windows
          path: AimLabs-windows.zip

  release:
    needs: build-windows
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: AimLabs-windows

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name || 'v1.0.0' }}
          name: AimLabs ${{ github.ref_name || 'v1.0.0' }}
          body: |
            ## AimLabs 瞄准训练器

            6种训练模式：Flick、Tracking、Speed、Precision、Reaction、Switch

            ### 使用方法
            1. 下载 `AimLabs-windows.zip`
            2. 解压到任意目录
            3. 双击 `AimLabs.exe` 运行（已内置JRE，无需安装Java）
          files: AimLabs-windows.zip
          draft: false
          prerelease: false
          generate_release_notes: false
